#!/usr/bin/env python3
from subprocess import Popen
import argparse


parser = argparse.ArgumentParser()
parser.add_argument("time", type=str)
args = parser.parse_args()

import ctypes

libc = ctypes.CDLL("libc.so.6")

# PR_SET_PDEATHSIG = 1, SIGKILL = 9
handle = Popen(["gnome-session-inhibit", "sleep", args.time], preexec_fn=lambda: libc.prctl(1, 9))

# Load Gtk
import gi

gi.require_version("Gtk", "4.0")
from gi.repository import Gtk, GLib


# When the application is launchedâ€¦
def on_activate(app):
    win = Gtk.ApplicationWindow(application=app)
    win.set_opacity(0.0)
    win.set_default_size(0, 0)
    win.present()


# Create a new application
app = Gtk.Application(application_id="moe.taoky.awake")
app.connect("activate", on_activate)


def check_popen_status():
    if handle.poll() is not None:
        app.quit()
    return True


# Run the application
try:
    GLib.timeout_add(1000, check_popen_status)
    app.run(None)
except KeyboardInterrupt:
    pass
finally:
    handle.kill()
